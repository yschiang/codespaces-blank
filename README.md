# API Gateway Error Handling Policy

## ğŸ“Š Overview

This document defines how errors are handled across the system architecture:

Client â†’ API Gateway â†’ Server

The system is designed with a **single Client and multiple Server implementations**. To maintain reliability and clarity, all error responses â€” regardless of which Server handles the request â€” must be **consistently identifiable and classifiable by the Client**. This design assumes **unary gRPC only** and is not intended to support streaming gRPC patterns.

## âœ… Error Categories

| Category | Origin                     | Description                                                   |
|----------|----------------------------|---------------------------------------------------------------|
| C1       | Client-side pre-send       | Timeout or interruption before request reaches API Gateway    |
| C2       | Client-side decode failure | Protobuf mismatch or transport-layer corruption               |
| C3       | API Gateway plugin error   | Authentication/authorization/middleware exception             |
| C4       | API Gateway routing error  | Route missing, upstream unavailable, connection failure       |
| S1       | Server application error   | Business logic error inside a valid gRPC response             |
| S2       | Server-side gRPC error     | Server returns gRPC status â‰  OK with trailer                  |

## ğŸ”„ API Gateway Behavior

### 1. Error occurs inside API Gateway (C3, C4)

- API Gateway captures and wraps the error.
- Returns:
  - gRPC status: appropriate error code (UNAVAILABLE, INTERNAL, etc.)
  - Trailer metadata:
    - x-error-code
    - x-error-message
    - x-error-retryable
    - x-error-origin
- âš  Note: In some low-level transport failures, trailer may not be transmitted.

### 2. Request successfully routed to Server (S1)

- API Gateway receives gRPC status = OK and forwards the response as-is.
- Server returns application error inside response body (not via gRPC error).
- Client must parse response body (e.g., success=false, error_code, message).

### 3. Server returns actual gRPC error (S2)

- API Gateway forwards gRPC status and trailer back to client.
- Client handles it via gRPC standard error path.

## ğŸ“¤ Pass-through Policy for Server Application Errors

When the API Gateway successfully forwards a request to the downstream Server and receives a valid response (gRPC status = OK), the Gateway does not inspect, rewrite, or repackage the response body, regardless of whether the Server indicates an application-level error.

### âœ… Design Principles

- **Responsibility of error generation**:
  - Application/business logic errors must be generated and encoded by the Server.
  - The API Gateway only handles infrastructure-level or routing errors.
- **Gateway behavior on server response**:
  - If the response from Server includes a valid gRPC status and a response body, the Gateway will pass it through without modification.
  - The Gateway does not interpret business flags such as `success = false` or `error_code`.
- **Client responsibility**:
  - The Client is responsible for inspecting the response body and interpreting whether it represents a success or application error.
  - This allows multiple Server implementations to conform to a shared envelope pattern, while keeping the Gateway behavior simple and generic.

### ğŸ§¾ Example Envelope Format (recommended)
```protobuf
message ApiResponse {
  bool success = 1;
  string error_code = 2;
  string error_message = 3;
  google.protobuf.Any payload = 4;
}
```

## ğŸ§¾ Client Responsibility

The client handles errors via the following logic:

```python
if gRPC status != OK:
    if trailer exists:
        parse x-error-code, x-error-message
    else:
        fallback to gRPC status only (e.g., retry if UNAVAILABLE)
else:
    if response body.success == false:
        parse error_code, message, details
```

## ğŸ” Retry and Observability

- `x-error-retryable` signals whether automatic retry is allowed.
- `x-error-code` enables centralized logging and metric aggregation.
- `x-error-origin` clarifies whether error originated from the API Gateway or Server.
- `request_id` (in header/trailer or body) must be traced in all errors.

## ğŸ’¡ Design Notes

- Application errors should be generated by Server, unless intercepted earlier by the API Gateway.
- The Gateway standardizes error shape when possible.
- Inconsistencies between body-based and trailer-based errors are tolerated via client-side logic.
- For observability, implement structured logging for all errors with category + request_id.

## âš ï¸ Known Limitations

| Limitation                          | Impact                          | Mitigation                                      |
|-------------------------------------|----------------------------------|-------------------------------------------------|
| Some errors cannot send trailer     | Client only sees gRPC status     | Use status code fallback + retry policy         |
| Application errors in body only     | Needs client parsing             | Standardize error envelope and enforce format   |

## ğŸ§¾ Error Examples

### ğŸ” C3 â€“ API Gateway Plugin Error (e.g., authentication failure)
```
gRPC Status: UNAUTHENTICATED
Trailer:
  x-error-code: PLUGIN_AUTH_FAILED
  x-error-message: "Invalid access token"
  x-error-retryable: false
  x-error-origin: gateway
```

### ğŸ”€ C4 â€“ API Gateway Routing Error (e.g., upstream timeout)
```
gRPC Status: DEADLINE_EXCEEDED
Trailer:
  x-error-code: UPSTREAM_TIMEOUT
  x-error-message: "Timeout contacting backend service"
  x-error-retryable: true
  x-error-origin: gateway
```

### ğŸ§  S1 â€“ Server Application Error (e.g., validation failed)
```
gRPC Status: OK
Response Body:
{
  "success": false,
  "error_code": "INVALID_ARGUMENT",
  "error_message": "Field 'waferId' is missing"
}
```

### âš ï¸ S2 â€“ Server gRPC Error (e.g., database timeout)
```
gRPC Status: UNAVAILABLE
Trailer:
  x-error-code: SERVER_DB_TIMEOUT
  x-error-message: "Database did not respond in time"
  x-error-retryable: true
  x-error-origin: server
```

## ğŸ“˜ Error Code Index

| Error Code             | Type               | gRPC Status         | Retryable | Origin    | Description                                                                 |
|------------------------|--------------------|----------------------|-----------|-----------|-----------------------------------------------------------------------------|
| CLIENT_TIMEOUT         | client_error        | CANCELLED            | âŒ        | client    | Client canceled the request before sending.                                |
| CLIENT_DECODE_FAILED   | client_error        | INTERNAL             | âŒ        | client    | Protobuf decode error, mismatch or invalid payload.                        |
| PLUGIN_AUTH_FAILED     | auth_error          | UNAUTHENTICATED      | âŒ        | gateway   | Invalid or missing authentication token.                                   |
| PLUGIN_RATE_LIMITED    | rate_limit          | RESOURCE_EXHAUSTED   | âœ…        | gateway   | Request throttled due to rate limits.                                      |
| ROUTE_NOT_FOUND        | routing_error       | UNIMPLEMENTED        | âŒ        | gateway   | API route is not defined or not yet deployed.                              |
| UPSTREAM_CONN_REFUSED  | routing_error       | UNAVAILABLE          | âœ…        | gateway   | Failed to connect to backend server.                                       |
| INVALID_ARGUMENT       | validation_error    | OK                   | âŒ        | server    | Server application indicates a missing or invalid argument.                |
| SERVER_DB_TIMEOUT      | infra_error         | UNAVAILABLE          | âœ…        | server    | Server could not complete due to database timeout.                         |
| SERVER_INTERNAL_ERROR  | infra_error         | INTERNAL             | âŒ        | server    | Unexpected internal server failure.                                        |

## Appendix A: API Error Category Matrix

| Category | Origin                     | Description                                                   |
|----------|----------------------------|---------------------------------------------------------------|
| C1       | Client-side pre-send       | Timeout or interruption before request reaches API Gateway    |
| C2       | Client-side decode failure | Protobuf mismatch or transport-layer corruption               |
| C3       | API Gateway plugin error   | Authentication/authorization/middleware exception             |
| C4       | API Gateway routing error  | Route missing, upstream unavailable, connection failure       |
| S1       | Server application error   | Business logic error inside a valid gRPC response             |
| S2       | Server-side gRPC error     | Server returns gRPC status â‰  OK with trailer                  |


## ğŸ“˜ Comprehensive Error Matrix

| Category | Error Condition            | gRPC Status         | x-error-code                 | Retryable | Who Handles It | Remarks                               | ä¾†æº     |
| -------- | -------------------------- | ------------------- | ---------------------------- | --------- | -------------- | ------------------------------------- | -------- |
| C1       | User canceled request      | N/A                 | CLIENT_CANCELLED             | No        | Client         | Request canceled before send          | âœ… åœ–ç‰‡å·²å« |
| C1       | Client-side deadline       | DEADLINE_EXCEEDED   | CLIENT_TIMEOUT               | Yes       | Client         | Client set timeout expired            | âœ… åœ–ç‰‡å·²å« |
| C1       | Network unreachable        | N/A                 | CLIENT_NETWORK_DOWN          | No        | Client         | Offline or no route to host           | ğŸ†• è£œå¼·  |
| C2       | Protobuf decode failure    | INTERNAL            | CLIENT_DECODE_FAILED         | No        | Client         | Likely schema mismatch                | âœ… åœ–ç‰‡å·²å« |
| C2       | Invalid content-type       | INTERNAL            | CLIENT_UNEXPECTED_CONTENT    | No        | Client         | Wrong/missing content-type            | ğŸ†• è£œå¼·  |
| C3       | Authentication failed      | UNAUTHENTICATED     | PLUGIN_AUTH_FAILED           | No        | Gateway        | Token missing or invalid              | âœ… åœ–ç‰‡å·²å« |
| C3       | Missing metadata           | INVALID_ARGUMENT    | PLUGIN_METADATA_MISSING      | No        | Gateway        | Validation by plugin                  | âœ… åœ–ç‰‡å·²å« |
| C3       | Rate limit exceeded        | RESOURCE_EXHAUSTED  | PLUGIN_RATE_LIMITED          | Yes       | Gateway        | Too many requests                     | âœ… åœ–ç‰‡å·²å« |
| C4       | Route not found            | UNIMPLEMENTED       | ROUTE_NOT_FOUND              | No        | Gateway        | No matching route                     | âœ… åœ–ç‰‡å·²å« |
| C4       | Upstream DNS failure       | UNAVAILABLE         | UPSTREAM_DNS_FAIL            | Yes       | Gateway        | DNS lookup failed                     | âœ… åœ–ç‰‡å·²å« |
| C4       | No backend endpoints       | UNAVAILABLE         | UPSTREAM_NO_ENDPOINT         | Yes       | Gateway        | No pod/endpoint available             | âœ… åœ–ç‰‡å·²å« |
| C4       | Connection refused         | UNAVAILABLE         | UPSTREAM_CONN_REFUSED        | Yes       | Gateway        | TCP port closed                       | âœ… åœ–ç‰‡å·²å« |
| C4       | Upstream timeout           | DEADLINE_EXCEEDED   | UPSTREAM_TIMEOUT             | Yes       | Gateway        | Timeout waiting for backend           | âœ… åœ–ç‰‡å·²å« |
| C4       | Transport reset            | INTERNAL            | TRANSPORT_CONNECTION_RESET   | Yes       | Gateway        | TCP reset by peer                     | âœ… åœ–ç‰‡å·²å« |
| S1       | App-level validation error | OK                  | N/A (in body)                | No        | Server         | ApiResponse.success = false           | âœ… åœ–ç‰‡å·²å« |
| S1       | Business rule violation    | OK                  | N/A (in body)                | No        | Server         | Soft failure handled in response body | âœ… åœ–ç‰‡å·²å« |
| S2       | Invalid input              | INVALID_ARGUMENT    | SERVER_INVALID_INPUT         | No        | Server         | gRPC status error with trailer        | âœ… åœ–ç‰‡å·²å« |
| S2       | Permission denied          | PERMISSION_DENIED   | SERVER_NO_PERMISSION         | No        | Server         | Missing role/privilege                | âœ… åœ–ç‰‡å·²å« |
| S2       | Internal exception         | INTERNAL            | SERVER_INTERNAL_ERROR        | Yes       | Server         | Unhandled exception or panic          | ğŸ†• è£œå¼·  |
| S2       | DB timeout                 | UNAVAILABLE         | SERVER_DB_TIMEOUT            | Yes       | Server         | Transient backend issue               | ğŸ†• è£œå¼·  |